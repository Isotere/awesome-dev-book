---
tags:
  - GoLang/GC
---
Сборщик мусора, основан на алгоритме Mark & Swip. Алгоритм меняется с каждой версией, так что некоторые детали могут устареть.

[Подробнее](https://go.dev/src/runtime/mgc.go)

- Mark - пометить
- Sweep - удалить

В го используется трех-цветная реализация данного алгоритма.

GC потребляет ресурсы: память и процессорный. Если запускается чаще - меньше памяти но занимает больше процессорного времени, и наоборот.

Понятие Stop The World (STW) - остановка работа программы на время работы сборщика. Полная остановка происходит в двух из трех этапов:

- Подготовка к сборке - останавливает программу
- Маркировка объектов (занимает 25% процентов доступных потоков, но не останавливает выполнение программы)
- Фактическая сборка - останавливает программу

Есть понятие "живой" кучи и "новой" кучи. GC запускается когда новая куча станет по размеру равна живой (поведение по умолчанию). И после очистки - живой кучей - станет вот эта очищенная суммарная куча.

Для управление тем, когда запускается GC есть переменная окружения GOGC=100 (100 - в процентах, значение по умолчанию)

Либо можно установить в рантайме с помощью:

```go
debug.SetGCPercent
```

Куча не может расти "бесконечно" в некоторых случаях: либо ограничение реальной физической памяти, либо например ограничения докер-контейнера, у которого стоит лимит по памяти и он будет убит при превышении (потеря тех данных ,которые обрабатывались в этот момент + простой программы).

Для этого в Го есть переменная окружения:

```go
GOMEMLIMIT или debug.SetMemoryLimit
```

Как только размер общий памяти приближается к этому лимиту - запускается сборщик мусора, независимо от размера новой кучи.

Может возникнуть ситуация, когда сборщик мусора будет выполняться 100% процессорного времени - когда размер кучи будет приближаться к размеру лимита. Это надо учитывать. Но Го немного предусмотрели это - у них реализованы "мягкие" лимиты - GC использует не более 50% рабочего времени и запускается не чаще чем 2 * GOMAXPROC сек.

Можно в некоторых случаях оптимизировать. Например если программа запускается как скрипт (выполнилась и закончилась, например задача в кроне), то можно (но не обязательно)

```go
GOGC=off + GOMEMLIMIT
```